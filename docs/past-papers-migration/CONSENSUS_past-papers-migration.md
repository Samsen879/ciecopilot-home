# 真题试卷和标准答案系统化迁移 - 共识文档

## 📋 需求确认

### 核心目标
将物理9702科目的真题试卷和标准答案PDF文件系统化迁移到RAG向量搜索系统，实现智能搜索和内容关联。

### 明确范围
- **科目范围**: 仅物理9702 (Physics)
- **文件类型**: PDF格式的past-papers和mark-schemes
- **时间范围**: 2016-2024年所有可用试卷
- **试卷类型**: Paper 1-5 的所有变体
- **集成点**: 现有PhysicsTopicDetail.jsx页面的RAG搜索功能

## 🏗️ 技术方案确认

### 数据库结构决策
**决策**: 复用现有rag_documents表结构，无需新增表
- 现有表已包含source_type字段，可区分'past_paper_pdf'和'mark_scheme_pdf'
- paper_code字段可存储试卷编码 (如'9702_s23_qp_12')
- 现有结构完全满足需求，避免过度设计

### 文件组织策略
**决策**: 基于source_type字段区分内容类型
- `source_type = 'past_paper_pdf'`: 真题试卷
- `source_type = 'mark_scheme_pdf'`: 标准答案
- `source_type = 'notes'`: 现有学习笔记

### 元数据提取方案
**决策**: 从文件路径和文件名自动解析
```javascript
// 示例: data/past-papers/9702Physics/paper1/9702_s23_qp_12.pdf
{
  subject_code: '9702',
  paper_code: '9702_s23_qp_12',
  source_type: 'past_paper_pdf',
  title: '9702_s23_qp_12',
  extra: {
    year: 2023,
    session: 'summer',
    paper_number: 1,
    variant: 2
  }
}
```

### 分块策略确认
**决策**: 使用现有的500 tokens分块，60 tokens重叠
- 适合试卷内容的问题和答案结构
- 保持与现有笔记内容的一致性
- 优化搜索准确性和上下文完整性

### 关联机制设计
**决策**: 通过paper_code字段建立试卷与答案的关联
- 试卷: `9702_s23_qp_12` → 答案: `9702_s23_ms_12`
- 前端搜索时可同时展示相关试卷和答案
- 支持按年份、考试季、试卷类型筛选

## 🎯 实现计划

### 技术约束确认
- **RAG脚本**: 复用现有rag_ingest.js，已支持PDF处理
- **PDF处理**: 使用现有pdf-parse库
- **向量化**: 使用text-embedding-3-small模型
- **数据库**: 现有Supabase PostgreSQL结构
- **API成本**: 预估约200-300个PDF文件，成本可控

### 前端集成方案
- **搜索界面**: 扩展现有PhysicsTopicDetail.jsx的搜索功能
- **结果展示**: 添加内容类型标识和筛选器
- **用户体验**: 支持按试卷类型、年份、考试季筛选

## ✅ 验收标准

### 功能验收
- [ ] 所有物理9702试卷PDF内容可通过RAG搜索
- [ ] 试卷和答案通过paper_code正确关联
- [ ] 搜索结果显示内容类型(试卷/答案/笔记)
- [ ] 支持按年份、考试季、试卷类型筛选
- [ ] 搜索响应时间<2秒
- [ ] 搜索结果准确性>85%

### 技术验收
- [ ] 所有PDF文件成功导入RAG数据库
- [ ] 元数据正确解析和存储
- [ ] 现有笔记搜索功能不受影响
- [ ] 代码符合项目规范
- [ ] 包含错误处理和日志记录
- [ ] 支持增量更新(新试卷添加)

### 数据质量验收
- [ ] PDF文本提取质量>90%
- [ ] 数学公式和符号正确识别
- [ ] 分块边界合理，不截断完整问题
- [ ] 向量嵌入质量验证通过

## 🚀 实施策略

### 分阶段执行
1. **阶段1**: 小批量测试(10个PDF文件)
2. **阶段2**: 单个年份完整迁移(2023年)
3. **阶段3**: 全量迁移(2016-2024年)
4. **阶段4**: 前端集成和用户体验优化

### 风险缓解
- **PDF质量**: 实施文本提取质量检查
- **API成本**: 分批处理，监控成本
- **性能影响**: 监控搜索响应时间
- **数据一致性**: 实施回滚机制

## 📊 预期成果

### 数据规模预估
- **PDF文件数量**: ~200-300个
- **文本块数量**: ~5000-8000个
- **向量维度**: 1536 (text-embedding-3-small)
- **存储空间**: ~50-100MB

### 用户价值
- 统一搜索入口：笔记、试卷、答案一站式搜索
- 智能关联：自动关联相关试卷和答案
- 高效复习：快速定位特定知识点的历年考题
- 个性化学习：基于搜索历史推荐相关内容

## 🔄 后续扩展

### 短期扩展(1-2周)
- 添加试卷难度标识
- 实现题目类型分类
- 支持按主题标签筛选

### 中期扩展(1-2月)
- 扩展到数学9709和进阶数学9231
- 添加试卷统计分析
- 实现学习进度跟踪

### 长期扩展(3-6月)
- AI驱动的个性化推荐
- 智能组卷功能
- 学习效果分析

---

**状态**: ✅ 共识达成，准备进入架构设计阶段
**确认人**: AI Agent
**确认时间**: 2024年当前时间
**下一步**: 生成详细的系统架构设计文档