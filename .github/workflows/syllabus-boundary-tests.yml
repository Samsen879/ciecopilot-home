name: Syllabus Boundary Tests

on:
  pull_request:
    paths:
      - 'apps/api-node/**'
      - 'libs/topic-path/**'
      - 'supabase/migrations/**'
      - 'test/fixtures/**'
      - '.github/workflows/syllabus-boundary-tests.yml'
  push:
    branches: [main]
    paths:
      - 'apps/api-node/**'
      - 'libs/topic-path/**'
      - 'supabase/migrations/**'
      - 'test/fixtures/**'

jobs:
  # ==========================================================================
  # Job 1: Unit Tests (no DB required)
  # ==========================================================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run topic-path unit tests
        env:
          NODE_OPTIONS: --experimental-vm-modules
        run: npx jest apps/api-node/api/tests/topic-path.test.js --passWithNoTests
      
      - name: Run API contract unit tests
        env:
          NODE_OPTIONS: --experimental-vm-modules
        run: npx jest apps/api-node/api/tests/syllabus-boundary-api-contract.test.js --testPathIgnorePatterns="Integration" --passWithNoTests

  # ==========================================================================
  # Job 2: Leakage Gate (CI Required - MUST PASS)
  # ==========================================================================
  syllabus-boundary-leakage-gate:
    name: Leakage Gate (Required)
    runs-on: ubuntu-latest
    needs: unit-tests
    
    services:
      postgres:
        image: pgvector/pgvector:pg16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: cie_copilot_test
        ports:
          - 54322:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Wait for PostgreSQL
        run: |
          for i in {1..30}; do
            pg_isready -h localhost -p 54322 -U postgres && break
            echo "Waiting for PostgreSQL..."
            sleep 2
          done
      
      - name: Setup test database
        env:
          PGHOST: localhost
          PGPORT: 54322
          PGUSER: postgres
          PGPASSWORD: postgres
          PGDATABASE: cie_copilot_test
        run: |
          # Create roles
          psql -c "DO \$\$ BEGIN IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'anon') THEN CREATE ROLE anon NOLOGIN; END IF; END \$\$;"
          psql -c "DO \$\$ BEGIN IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'authenticated') THEN CREATE ROLE authenticated NOLOGIN; END IF; END \$\$;"
          psql -c "DO \$\$ BEGIN IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'service_role') THEN CREATE ROLE service_role NOLOGIN; END IF; END \$\$;"
          
          # Apply shims (creates auth schema stubs)
          psql -f test/fixtures/supabase-shims.sql
          
          # Initialize test database with full schema
          # (creates chunks, curriculum_nodes tables and hybrid_search_v2 RPC)
          psql -v ON_ERROR_STOP=1 -f test/fixtures/init-test-db.sql
          
          # Apply seed data
          psql -v ON_ERROR_STOP=1 -f test/fixtures/syllabus_boundary_seed.sql
      
      - name: Run leakage tests
        env:
          NODE_OPTIONS: --experimental-vm-modules
          TEST_DB_HOST: localhost
          TEST_DB_PORT: 54322
          TEST_DB_NAME: cie_copilot_test
          TEST_DB_USER: postgres
          TEST_DB_PASSWORD: postgres
        run: npx jest apps/api-node/api/tests/syllabus-boundary-leakage.test.js --forceExit --detectOpenHandles
      
      - name: Run RPC tests
        env:
          NODE_OPTIONS: --experimental-vm-modules
          TEST_DB_HOST: localhost
          TEST_DB_PORT: 54322
          TEST_DB_NAME: cie_copilot_test
          TEST_DB_USER: postgres
          TEST_DB_PASSWORD: postgres
        run: npx jest apps/api-node/api/tests/syllabus-boundary-rpc.test.js --forceExit --detectOpenHandles

  # ==========================================================================
  # Job 3: API Contract Tests
  # ==========================================================================
  api-contract-tests:
    name: API Contract Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run API contract tests
        env:
          NODE_OPTIONS: --experimental-vm-modules
        run: npx jest apps/api-node/api/tests/syllabus-boundary-api-contract.test.js --forceExit

