# 拍照搜题技术方案重新分析

## 用户需求明确

用户的核心需求：
- 学生做真题时遇到不会的题目
- 拍照识别题目内容
- AI从数据库中识别这道题是哪一年的试卷
- 给出具体来源（年份、考试季、试卷类型、题号）
- 提供对应的mark scheme（答案）
- 将相关文件添加到AI上下文中供进一步提问

## 当前RAG方案的问题分析

### 1. 向量嵌入的局限性
- **语义搜索 vs 精确匹配**：向量嵌入适合语义相似性搜索，但拍照搜题需要的是精确的题目匹配
- **数学公式处理**：向量嵌入对数学公式、图表、符号的处理效果有限
- **计算成本**：生成向量嵌入需要大量计算资源和时间
- **存储成本**：向量数据库存储成本较高

### 2. 真题特点分析
- **结构化内容**：真题有明确的题号、分值、题型结构
- **重复性低**：每道题都是独特的，不需要语义相似性搜索
- **精确匹配需求**：需要找到完全相同的题目，而非相似题目
- **元数据重要性**：年份、考试季、试卷类型比内容相似性更重要

## 更适合的技术方案

### 方案A：结构化存储 + OCR精确匹配

#### 数据存储结构
```sql
-- 试卷表
CREATE TABLE papers (
  id UUID PRIMARY KEY,
  subject_code VARCHAR(10), -- 9702
  year INTEGER,             -- 2023
  session VARCHAR(10),      -- summer/winter
  paper_type VARCHAR(10),   -- qp/ms
  paper_number INTEGER,     -- 11/12/13
  file_path TEXT,
  created_at TIMESTAMP
);

-- 题目表
CREATE TABLE questions (
  id UUID PRIMARY KEY,
  paper_id UUID REFERENCES papers(id),
  question_number VARCHAR(10), -- 1, 2a, 2b(i)
  page_number INTEGER,
  content_text TEXT,           -- OCR提取的纯文本
  content_hash VARCHAR(64),    -- 内容哈希用于快速匹配
  marks INTEGER,               -- 分值
  question_type VARCHAR(20),   -- multiple_choice, calculation, essay
  has_diagram BOOLEAN,         -- 是否包含图表
  created_at TIMESTAMP
);

-- 答案表
CREATE TABLE mark_schemes (
  id UUID PRIMARY KEY,
  question_id UUID REFERENCES questions(id),
  answer_text TEXT,
  marking_points JSONB,        -- 评分要点
  created_at TIMESTAMP
);
```

#### 匹配算法
1. **OCR文本提取**：从拍照图片中提取文本
2. **文本预处理**：去除空格、标点符号标准化
3. **哈希匹配**：计算内容哈希进行快速匹配
4. **模糊匹配**：使用编辑距离算法处理OCR误差
5. **结构化验证**：通过题号、分值等结构化信息验证匹配结果

### 方案B：混合方案（推荐）

#### 核心思路
- **主要匹配**：使用文本哈希和模糊匹配
- **辅助验证**：保留少量向量嵌入用于验证和排序
- **元数据优先**：优先使用年份、考试季等元数据筛选

#### 实现步骤
1. **数据预处理**：
   - 提取PDF中的题目结构
   - 生成题目文本哈希
   - 提取元数据（年份、考试季等）
   - 可选：生成轻量级向量嵌入

2. **拍照搜题流程**：
   ```
   用户拍照 → OCR识别 → 文本预处理 → 哈希匹配 → 模糊匹配 → 结果验证 → 返回答案
   ```

3. **匹配优先级**：
   - 一级：精确哈希匹配
   - 二级：高相似度模糊匹配（编辑距离 < 10%）
   - 三级：向量相似度匹配（可选）
   - 验证：元数据一致性检查

## 技术实现建议

### 1. 停止当前向量嵌入处理
- 当前的RAG向量化处理对拍照搜题意义不大
- 可以保留已处理的数据，但不需要继续大规模向量化

### 2. 重新设计数据处理流程
- 重点提取题目结构化信息
- 生成文本哈希用于快速匹配
- 建立题目与答案的精确对应关系

### 3. OCR集成方案
- 使用现有OCR服务（如Google Vision API、Azure Computer Vision）
- 针对数学公式优化（如MathPix API）
- 处理图表和图形识别

### 4. 前端拍照界面
- 相机拍照功能
- 图片预处理（裁剪、增强）
- 实时反馈和结果展示

## 成本效益分析

### 当前RAG方案成本
- 向量生成：高计算成本
- 向量存储：高存储成本
- 查询速度：相对较慢
- 准确性：对精确匹配支持有限

### 建议方案成本
- 文本处理：低计算成本
- 哈希存储：极低存储成本
- 查询速度：极快
- 准确性：高精确匹配率

## 下一步行动建议

1. **立即停止**：当前的向量嵌入处理
2. **重新设计**：数据库结构和处理流程
3. **开发POC**：拍照搜题原型验证
4. **逐步实现**：OCR → 匹配算法 → 前端界面

## 结论

对于拍照搜题功能，**向量嵌入不是必要的**，甚至可能是低效的。更适合的方案是：

1. **结构化存储**：将题目按结构化方式存储
2. **精确匹配**：使用文本哈希和模糊匹配算法
3. **元数据驱动**：优先使用年份、考试季等元数据
4. **轻量级实现**：降低计算和存储成本

这种方案不仅更适合拍照搜题的需求，还能显著降低系统复杂度和运营成本。