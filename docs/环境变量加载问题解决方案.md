# 环境变量加载问题解决方案

## 问题描述

在运行 RAG 摄取和搜索脚本时，需要手动在 PowerShell 中加载环境变量才能正常工作。这个问题的根本原因是多方面的：

## 根本原因分析

### 1. 环境变量命名不一致

**问题**：不同脚本使用了不同的环境变量名称
- `rag_ingest.js` 使用：`SUPABASE_URL` 或 `VITE_SUPABASE_URL`
- `check_rag_status.js` 原本只使用：`VITE_SUPABASE_URL`
- `.env` 文件中定义的是：`SUPABASE_URL`

**解决方案**：✅ 已修复
- 更新 `check_rag_status.js` 使用回退机制：`process.env.SUPABASE_URL || process.env.VITE_SUPABASE_URL`

### 2. dotenv 配置问题

**问题**：`.env` 文件中的注释导致变量解析错误
- 原始配置：`VECTOR_EMBEDDING_MODEL=text-embedding-v4 # DashScope Qwen embedding model`
- 导致 API 调用失败，因为模型名称包含了注释部分

**解决方案**：✅ 已修复
- 移除了 `VECTOR_EMBEDDING_MODEL` 配置行末的注释

### 3. PowerShell 环境变量作用域

**问题**：Node.js 脚本通过 `dotenv.config()` 加载 `.env` 文件，但这只在脚本运行时生效
- PowerShell 会话本身不会自动加载 `.env` 文件
- 每次新的 PowerShell 会话都需要重新加载

## 永久解决方案

### 方案1：脚本自动加载（推荐）✅

所有脚本都已正确配置 `dotenv.config()`：

```javascript
import dotenv from 'dotenv';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// 加载 .env 文件
dotenv.config();
dotenv.config({ path: path.resolve(__dirname, '../.env.local'), override: true });
```

### 方案2：环境变量回退机制（已实现）✅

所有脚本都使用多重回退机制：

```javascript
const SUPABASE_URL = process.env.SUPABASE_URL || process.env.VITE_SUPABASE_URL;
const SUPABASE_KEY = 
  process.env.SUPABASE_SERVICE_ROLE_KEY ||
  process.env.SUPABASE_SERVICE_ROLE ||
  process.env.VITE_SUPABASE_SERVICE_ROLE_KEY ||
  process.env.SUPABASE_ANON_KEY ||
  process.env.VITE_SUPABASE_ANON_KEY;
```

### 方案3：PowerShell 配置文件（可选）

如果希望在 PowerShell 会话中也能访问这些环境变量，可以创建 PowerShell 配置文件：

```powershell
# 在 PowerShell 中运行以下命令查看配置文件路径
$PROFILE

# 编辑配置文件，添加环境变量加载脚本
# 注意：这种方式会暴露敏感信息，不推荐
```

## 当前状态

### ✅ 已修复的问题

1. **环境变量命名不一致**：所有脚本现在都使用回退机制
2. **注释导致的解析错误**：已移除 `.env` 文件中的行末注释
3. **脚本自动加载**：所有脚本都正确配置了 `dotenv.config()`

### 🎯 验证结果

- ✅ `rag_ingest.js` 正常运行，正在处理 9702 notes 摄取
- ✅ `check_rag_status.js` 正常运行，无需手动加载环境变量
- ✅ `rag_search_demo.js` 正常运行

## 最佳实践建议

### 1. 环境变量命名规范

- 使用一致的命名约定
- 提供多重回退机制
- 避免在 `.env` 文件中使用行末注释

### 2. 脚本配置标准

```javascript
// 标准的环境变量加载模式
import dotenv from 'dotenv';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// 加载环境变量
dotenv.config();
dotenv.config({ path: path.resolve(__dirname, '../.env.local'), override: true });

// 使用回退机制
const REQUIRED_VAR = process.env.PRIMARY_NAME || process.env.FALLBACK_NAME;
```

### 3. 错误处理

```javascript
// 验证必需的环境变量
if (!SUPABASE_URL || !SUPABASE_KEY) {
  throw new Error('Missing required environment variables');
}
```

## 结论

**问题已完全解决**。现在所有脚本都能自动加载 `.env` 文件中的环境变量，无需手动在 PowerShell 中设置。这是通过以下措施实现的：

1. 修复了环境变量命名不一致问题
2. 移除了导致解析错误的注释
3. 确保所有脚本都正确配置了 `dotenv.config()`
4. 实现了健壮的回退机制

**以后不再需要手动加载环境变量**，所有脚本都会自动从 `.env` 文件加载配置。